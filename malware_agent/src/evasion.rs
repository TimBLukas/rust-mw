use sysinfo::{Disks, System};

/// Prüft heuristisch, ob die aktuelle Umgebung als „sicher“ eingestuft wird.
///
/// Args:
/// - keine
///
/// Returns:
/// - true: Umgebung erfüllt Mindestanforderungen (RAM, CPU, Disk)
/// - false: Verdacht auf Sandbox / VM
pub fn is_safe_environment() -> bool {
    println!("[EVASION] Starte Umgebungsscan...");

    // System Objekt erstellen
    let mut sys = System::new_all();

    // Daten aktualisieren
    sys.refresh_memory();
    sys.refresh_all();

    // RAM prüfen
    let total_memory_mb = sys.total_memory() / 1024;

    // Für Beispiel: test ob mehr als 3 GB
    if total_memory_mb < 3072 {
        println!(
            "[EVASION] Zu wenig RAM ({} MB). Sandbox Verdacht!",
            total_memory_mb
        );
        return false;
    }

    // CPU Cores prüfen
    if sys.cpus().len() < 3 {
        println!(
            "[EVASION] Zu wenig CPU Cores ({}). VM Verdacht!",
            sys.cpus().len()
        );
        return false;
    }

    // Disk Space prüfen
    let disks = Disks::new_with_refreshed_list();

    // Wir summieren den Platz aller gemounteten Disks
    let total_disk_space: u64 = disks.list().iter().map(|disk| disk.total_space()).sum();
    let total_disk_gb = total_disk_space / 1024 / 1024 / 1024;

    if total_disk_gb < 60 {
        println!(
            "[EVASION] FAIL: Festplatte verdächtig klein ({} GB). Sandbox Verdacht!",
            total_disk_gb
        );
        return false;
    }

    true
}
